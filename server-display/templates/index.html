<!DOCTYPE html>
<html>

<head>
    <title>GSR + EEG Monitor</title>

    <!-- Core libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Luxon for time handling -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>

    <!-- Realtime plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            margin: 30px;
            background: #f5f7fa;
            color: #111;
        }

        canvas {
            background: #fff;
            border: 1px solid #ccc;
            margin: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        #dealerCards img {
            height: 220px;
            border: 1px solid #aaa;
            border-radius: 20px;
        }
    </style>
</head>

<body>
    <h1>PLAYER Biofeedback Dashboard</h1>

    <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
        <div style="text-align: center;">
            <h2>GSR (Galvanic Skin Response)</h2>
            <canvas id="gsrChart" width="800" height="350"></canvas>
        </div>
        <div style="text-align: center;">
            <h2>Cognitive State Intensities</h2>
            <canvas id="cogChart" width="800" height="350"></canvas>
        </div>
    </div>

    <div style="display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap;">
        <div style="text-align: center;">
            <h2>EEG Channels (Live - Subplots)</h2>
            <canvas id="eegSubplotCanvas" width="750" height="300"></canvas>
        </div>

        <div style="text-align: center;">
            <h2>Dealer</h2>
            <div id="dealerCards" style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                <!-- Cards will be injected here -->
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        // ------------- GSR Chart -------------
        const gsrCtx = document.getElementById('gsrChart').getContext('2d');
        const gsrChart = new Chart(gsrCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'GSR',
                    data: [],
                    borderWidth: 1,
                    borderColor: 'rgba(75,192,192,1)',
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        type: 'realtime',
                        realtime: {
                            duration: 8000, // last 8 secs
                            delay: 1000,
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // ------------- Cognitive State Chart -------------
        const stateCtx = document.getElementById('cogChart').getContext('2d');
        const states = ['Relaxed', 'Focused', 'Cognitive Load', 'Drowsy', 'Neutral'];
        const stateColors = {
            Relaxed: 'blue',
            Focused: 'green',
            'Cognitive Load': 'orange',
            Drowsy: 'purple',
            Neutral: 'gray'
        };

        const cogChart = new Chart(stateCtx, {
            type: 'line',
            data: {
                datasets: states.map(state => ({
                    label: state,
                    data: [],
                    borderColor: stateColors[state],
                    fill: false,
                    tension: 0.2
                }))
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        type: 'realtime',
                        realtime: {
                            duration: 8000, // 8 secs
                            delay: 1000,
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 1.0,
                        title: {
                            display: true,
                            text: 'State Intensity (Normalized)'
                        }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // ------------- EEG Subplot Canvas (Custom Rendered) -------------
        const eegChannels = ['FZ', 'C3', 'CZ', 'C4', 'PZ', 'PO7', 'OZ', 'PO8'];
        const eegBufferLength = 250; // ~1s of data at 250Hz
        const eegBuffers = eegChannels.map(() => []);
        const subplotCanvas = document.getElementById('eegSubplotCanvas');
        const ctx = subplotCanvas.getContext('2d');

        function drawEEGSubplots() {
            const w = subplotCanvas.width;
            const h = subplotCanvas.height;

            ctx.clearRect(0, 0, w, h);

            const colCount = 4;
            const rowCount = 2;
            const subplotW = w / colCount;
            const subplotH = h / rowCount;

            eegChannels.forEach((label, i) => {
                const col = i % colCount;
                const row = Math.floor(i / colCount);
                const x0 = col * subplotW;
                const y0 = row * subplotH;

                const buffer = eegBuffers[i];
                if (buffer.length < 2) return;

                // Normalize values
                const min = Math.min(...buffer);
                const max = Math.max(...buffer);
                const range = max - min || 1;

                // Label
                ctx.fillStyle = "#000";
                ctx.font = "12px sans-serif";
                ctx.fillText(label, x0 + 5, y0 + 15);

                // Line
                ctx.beginPath();
                ctx.strokeStyle = `hsl(${i * 45}, 70%, 50%)`;
                ctx.lineWidth = 1;

                for (let j = 0; j < buffer.length; j++) {
                    const x = x0 + (j / buffer.length) * subplotW;
                    const y = y0 + ((1 - (buffer[j] - min) / range) * subplotH);
                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }

                ctx.stroke();
            });
        }

        // ----- Dealer init: show 5 face-down cards -----
        const container = document.getElementById('dealerCards');
        for (let i = 0; i < 5; i++) {
            const img = document.createElement('img');
            img.src = `/static/cards/BACK.png`;
            container.appendChild(img);
        }

        // ------------- Socket Handlers -------------
        socket.on('gsr_data', data => {
            const timestamp = Date.now();
            gsrChart.data.datasets[0].data.push({ x: timestamp, y: data.value });
        });

        socket.on('eeg_data', data => {
            const values = data.data;
            for (let i = 0; i < eegBuffers.length; i++) {
                eegBuffers[i].push(values[i]);
                if (eegBuffers[i].length > eegBufferLength) {
                    eegBuffers[i].shift();
                }
            }
            drawEEGSubplots();
        });

        socket.on('cognitive_state', data => {
            const timestamp = Date.now();
            const values = data.state || data.values;

            for (const state of states) {
                const dataset = cogChart.data.datasets.find(d => d.label === state);
                if (dataset && values[state] !== undefined) {
                    dataset.data.push({ x: timestamp, y: values[state] });
                }
            }
        });
        // Flush time series charts every 30 seconds
        //setInterval(() => {
        //    console.log('ðŸ§¹ Flushing time series buffers...');
        //    gsrChart.data.datasets.forEach(ds => ds.data = []);
        //    cogChart.data.datasets.forEach(ds => ds.data = []);
        //    gsrChart.update('none');
        //    cogChart.update('none');
        //}, 10000);  // every 10s

        if (!subplotCanvas) {
            console.error("âŒ eegSubplotCanvas not found in DOM!");
        }

        // ----- Dealer ------
        socket.on('dealer_card', data => {
            const code = data.code;
            const img = document.createElement('img');
            img.src = `/static/cards/${code}.png`;

            const container = document.getElementById('dealerCards');
            const cards = Array.from(container.children);

            if (cards.length === 5) {
                // Replace the last BACK (rightmost)
                for (let i = 4; i >= 0; i--) {
                    if (cards[i].src.includes('BACK.png')) {
                        container.replaceChild(img, cards[i]);
                        return;
                    }
                }

                // If no BACKs left, reset the hand
                container.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const back = document.createElement('img');
                    back.src = `/static/cards/BACK.png`;
                    container.appendChild(back);
                }

                // Replace the first BACK (rightmost again)
                container.replaceChild(img, container.children[4]);
            }
        });


    </script>
</body>

</html>